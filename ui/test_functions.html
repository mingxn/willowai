<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Plant Chatbot Functions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #27ae60;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <h1>üß™ Test Plant Chatbot Functions</h1>
    
    <div class="test-section">
        <h2>1. Test API Connection</h2>
        <button class="test-button" onclick="testApiConnection()">Test API Health</button>
        <div id="api-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Test Schedule Management</h2>
        <button class="test-button" onclick="testCreateSchedule()">Create Test Schedule</button>
        <button class="test-button" onclick="testGetSchedules()">Get All Schedules</button>
        <button class="test-button" onclick="testUpcomingReminders()">Test Upcoming Reminders</button>
        <button class="test-button" onclick="testClearSchedules()">Clear All Schedules</button>
        <div id="schedule-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Formatting Functions</h2>
        <button class="test-button" onclick="testAnalysisFormatting()">Test Analysis Formatting</button>
        <button class="test-button" onclick="testJsonFormatting()">Test JSON Formatting</button>
        <div id="format-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. Test Helper Functions</h2>
        <button class="test-button" onclick="testCareTypeIcons()">Test Care Type Icons</button>
        <button class="test-button" onclick="testTimeFormatting()">Test Time Formatting</button>
        <button class="test-button" onclick="testNotifications()">Test Notifications</button>
        <div id="helper-result" class="result"></div>
    </div>

    <script>
        // Mock schedule data for testing
        let testSchedules = [];
        let scheduleIdCounter = 1;

        // Test API Connection
        async function testApiConnection() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = 'Testing API connection...';
            
            try {
                const response = await fetch('http://127.0.0.1:5000/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    resultEl.className = 'result success';
                    resultEl.textContent = `‚úÖ API Connection Success!\nStatus: ${data.status}\nMessage: ${data.message}\nOpenAI: ${data.openai_status}`;
                } else {
                    throw new Error('API not healthy');
                }
            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå API Connection Failed!\nError: ${error.message}`;
            }
        }

        // Test Schedule Creation
        function testCreateSchedule() {
            const resultEl = document.getElementById('schedule-result');
            
            try {
                // Mock new schedule
                const newSchedule = {
                    id: scheduleIdCounter++,
                    plantName: 'C√¢y hoa h·ªìng test',
                    careType: 'watering',
                    startDate: new Date(Date.now() + 30 * 60 * 1000), // 30 minutes from now
                    repeatType: 'daily',
                    repeatCount: 7,
                    notes: 'Test schedule for demo',
                    completedDates: [],
                    createdAt: new Date()
                };

                testSchedules.push(newSchedule);
                localStorage.setItem('plantCareSchedules', JSON.stringify(testSchedules));

                resultEl.className = 'result success';
                resultEl.textContent = `‚úÖ Schedule Created Successfully!
ID: ${newSchedule.id}
Plant: ${newSchedule.plantName}
Care Type: ${getCareTypeName(newSchedule.careType)}
Start: ${formatDateTime(newSchedule.startDate)}
Repeat: ${getRepeatText(newSchedule)}`;

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå Schedule Creation Failed!\nError: ${error.message}`;
            }
        }

        // Test Get Schedules
        function testGetSchedules() {
            const resultEl = document.getElementById('schedule-result');
            
            try {
                const saved = localStorage.getItem('plantCareSchedules');
                const schedules = saved ? JSON.parse(saved) : [];

                resultEl.className = 'result success';
                resultEl.textContent = `‚úÖ Retrieved ${schedules.length} schedules:\n\n` + 
                    schedules.map(s => `${s.id}. ${s.plantName} - ${getCareTypeName(s.careType)}`).join('\n');

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå Get Schedules Failed!\nError: ${error.message}`;
            }
        }

        // Test Upcoming Reminders
        function testUpcomingReminders() {
            const resultEl = document.getElementById('schedule-result');
            
            try {
                const saved = localStorage.getItem('plantCareSchedules');
                const schedules = saved ? JSON.parse(saved) : [];
                
                const now = new Date();
                const next24Hours = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                
                const upcoming = schedules.filter(schedule => {
                    const nextDate = getNextReminderDate(schedule);
                    return nextDate && nextDate <= next24Hours && nextDate >= now;
                });

                resultEl.className = 'result success';
                resultEl.textContent = `‚úÖ Found ${upcoming.length} upcoming reminders:\n\n` + 
                    upcoming.map(s => `${s.plantName} - ${getCareTypeName(s.careType)} - ${formatReminderTime(getNextReminderDate(s))}`).join('\n');

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå Upcoming Reminders Failed!\nError: ${error.message}`;
            }
        }

        // Test Clear Schedules
        function testClearSchedules() {
            const resultEl = document.getElementById('schedule-result');
            
            try {
                localStorage.removeItem('plantCareSchedules');
                testSchedules = [];
                scheduleIdCounter = 1;

                resultEl.className = 'result success';
                resultEl.textContent = '‚úÖ All schedules cleared!';

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå Clear Schedules Failed!\nError: ${error.message}`;
            }
        }

        // Test Analysis Formatting
        function testAnalysisFormatting() {
            const resultEl = document.getElementById('format-result');
            
            try {
                const testAnalysis = {
                    "1. NH·∫¨N D·∫†NG C√ÇY": {
                        "T√™n khoa h·ªçc v√† t√™n th√¥ng th∆∞·ªùng": {
                            "T√™n khoa h·ªçc": "Rosa damascena",
                            "T√™n th√¥ng th∆∞·ªùng": "Hoa h·ªìng Damascus"
                        },
                        "H·ªç th·ª±c v·∫≠t": "Rosaceae",
                        "ƒê·ªô tin c·∫≠y nh·∫≠n d·∫°ng (%)": "95"
                    },
                    "2. T√åNH TR·∫†NG S·ª®C KH·ªéE": {
                        "T√¨nh tr·∫°ng t·ªïng th·ªÉ": "Kh·ªèe m·∫°nh",
                        "M·ª©c ƒë·ªô nghi√™m tr·ªçng": "Kh√¥ng c√≥"
                    }
                };

                const formatted = formatStructuredAnalysis(testAnalysis);
                
                resultEl.className = 'result success';
                resultEl.innerHTML = '‚úÖ Analysis Formatting Test:\n\n' + formatted;

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå Analysis Formatting Failed!\nError: ${error.message}`;
            }
        }

        // Test JSON Formatting
        function testJsonFormatting() {
            const resultEl = document.getElementById('format-result');
            
            try {
                const testJson = `{
                    "plant_type": "Rose",
                    "health_status": "Good",
                    "recommendations": ["Water daily", "Add fertilizer"]
                }`;

                const parsed = JSON.parse(testJson);
                const formatted = formatJsonValue(parsed);
                
                resultEl.className = 'result success';
                resultEl.innerHTML = '‚úÖ JSON Formatting Test:\n\n' + formatted;

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå JSON Formatting Failed!\nError: ${error.message}`;
            }
        }

        // Test Care Type Icons
        function testCareTypeIcons() {
            const resultEl = document.getElementById('helper-result');
            
            try {
                const careTypes = ['watering', 'fertilizing', 'pruning', 'repotting', 'spraying', 'checking'];
                const results = careTypes.map(type => 
                    `${getCareTypeIcon(type)} ${type} - ${getCareTypeName(type)}`
                );

                resultEl.className = 'result success';
                resultEl.textContent = '‚úÖ Care Type Icons Test:\n\n' + results.join('\n');

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå Care Type Icons Failed!\nError: ${error.message}`;
            }
        }

        // Test Time Formatting
        function testTimeFormatting() {
            const resultEl = document.getElementById('helper-result');
            
            try {
                const now = new Date();
                const future = new Date(now.getTime() + 45 * 60 * 1000); // 45 minutes later
                const tomorrow = new Date(now.getTime() + 25 * 60 * 60 * 1000); // 25 hours later

                const results = [
                    `Current time: ${formatDateTime(now)}`,
                    `45 min from now: ${formatReminderTime(future)}`,
                    `Tomorrow: ${formatReminderTime(tomorrow)}`
                ];

                resultEl.className = 'result success';
                resultEl.textContent = '‚úÖ Time Formatting Test:\n\n' + results.join('\n');

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå Time Formatting Failed!\nError: ${error.message}`;
            }
        }

        // Test Notifications
        function testNotifications() {
            const resultEl = document.getElementById('helper-result');
            
            try {
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        new Notification('Test Notification', {
                            body: 'This is a test notification from Plant AI!',
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üåø</text></svg>'
                        });
                        
                        resultEl.className = 'result success';
                        resultEl.textContent = '‚úÖ Notification sent successfully!';
                    } else if (Notification.permission === 'default') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                new Notification('Permission Granted!', {
                                    body: 'You will now receive plant care reminders.',
                                });
                                resultEl.className = 'result success';
                                resultEl.textContent = '‚úÖ Notification permission granted and test sent!';
                            } else {
                                resultEl.className = 'result error';
                                resultEl.textContent = '‚ùå Notification permission denied!';
                            }
                        });
                    } else {
                        resultEl.className = 'result error';
                        resultEl.textContent = '‚ùå Notifications are blocked!';
                    }
                } else {
                    resultEl.className = 'result error';
                    resultEl.textContent = '‚ùå This browser does not support notifications!';
                }

            } catch (error) {
                resultEl.className = 'result error';
                resultEl.textContent = `‚ùå Notification Test Failed!\nError: ${error.message}`;
            }
        }

        // Helper Functions (copied from PlantChatbot.vue)
        function getCareTypeIcon(careType) {
            const icons = {
                watering: 'üíß',
                fertilizing: 'üå±',
                pruning: '‚úÇÔ∏è',
                repotting: 'ü™¥',
                spraying: 'üí®',
                checking: 'üîç'
            };
            return icons[careType] || 'üåø';
        }

        function getCareTypeName(careType) {
            const names = {
                watering: 'T∆∞·ªõi n∆∞·ªõc',
                fertilizing: 'B√≥n ph√¢n',
                pruning: 'T·ªâa c√†nh',
                repotting: 'Thay ch·∫≠u',
                spraying: 'Phun thu·ªëc',
                checking: 'Ki·ªÉm tra s·ª©c kh·ªèe'
            };
            return names[careType] || 'ChƒÉm s√≥c';
        }

        function getRepeatText(schedule) {
            if (schedule.repeatType === 'none') {
                return 'Kh√¥ng l·∫∑p l·∫°i';
            }
            const typeNames = {
                daily: 'h√†ng ng√†y',
                weekly: 'h√†ng tu·∫ßn',
                monthly: 'h√†ng th√°ng'
            };
            return `L·∫∑p l·∫°i ${typeNames[schedule.repeatType]} (${schedule.repeatCount} l·∫ßn)`;
        }

        function formatDateTime(date) {
            return new Date(date).toLocaleString('vi-VN');
        }

        function formatReminderTime(date) {
            const now = new Date();
            const diff = date - now;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(minutes / 60);

            if (minutes < 60) {
                return `${minutes} ph√∫t n·ªØa`;
            } else if (hours < 24) {
                return `${hours} gi·ªù n·ªØa`;
            } else {
                return date.toLocaleDateString('vi-VN');
            }
        }

        function getNextReminderDate(schedule) {
            const now = new Date();
            let nextDate = new Date(schedule.startDate);

            if (schedule.repeatType === 'none') {
                return nextDate > now ? nextDate : null;
            }

            let count = 0;
            while (nextDate <= now && count < schedule.repeatCount) {
                switch (schedule.repeatType) {
                    case 'daily':
                        nextDate.setDate(nextDate.getDate() + 1);
                        break;
                    case 'weekly':
                        nextDate.setDate(nextDate.getDate() + 7);
                        break;
                    case 'monthly':
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        break;
                }
                count++;
            }

            return count < schedule.repeatCount ? nextDate : null;
        }

        function formatStructuredAnalysis(data) {
            let formatted = 'üìä <strong>K·∫øt qu·∫£ ph√¢n t√≠ch chi ti·∫øt:</strong><br><br>';

            for (const [key, value] of Object.entries(data)) {
                if (key.includes('NH·∫¨N D·∫†NG') || key.includes('1.')) {
                    formatted += 'üîç <strong>NH·∫¨N D·∫†NG C√ÇY</strong><br>';
                    formatted += formatPlantIdentification(value) + '<br>';
                } else if (key.includes('T√åNH TR·∫†NG') || key.includes('2.')) {
                    formatted += '‚öïÔ∏è <strong>T√åNH TR·∫†NG S·ª®C KH·ªéE</strong><br>';
                    formatted += formatHealthStatus(value) + '<br>';
                }
            }

            return formatted;
        }

        function formatPlantIdentification(data) {
            let result = '';
            if (data['T√™n khoa h·ªçc v√† t√™n th√¥ng th∆∞·ªùng']) {
                const names = data['T√™n khoa h·ªçc v√† t√™n th√¥ng th∆∞·ªùng'];
                result += `üè∑Ô∏è <strong>T√™n khoa h·ªçc:</strong> ${names['T√™n khoa h·ªçc'] || 'Ch∆∞a x√°c ƒë·ªãnh'}<br>`;
                result += `üåø <strong>T√™n th√¥ng th∆∞·ªùng:</strong> ${names['T√™n th√¥ng th∆∞·ªùng'] || 'Ch∆∞a x√°c ƒë·ªãnh'}<br>`;
            }
            if (data['H·ªç th·ª±c v·∫≠t']) {
                result += `üå≥ <strong>H·ªç th·ª±c v·∫≠t:</strong> ${data['H·ªç th·ª±c v·∫≠t']}<br>`;
            }
            if (data['ƒê·ªô tin c·∫≠y nh·∫≠n d·∫°ng (%)']) {
                result += `üìä <strong>ƒê·ªô tin c·∫≠y:</strong> ${data['ƒê·ªô tin c·∫≠y nh·∫≠n d·∫°ng (%)']}%<br>`;
            }
            return result;
        }

        function formatHealthStatus(data) {
            let result = '';
            if (data['T√¨nh tr·∫°ng t·ªïng th·ªÉ']) {
                const status = data['T√¨nh tr·∫°ng t·ªïng th·ªÉ'];
                const statusIcon = status === 'Kh·ªèe m·∫°nh' ? 'üíö' : status === 'B·ªánh' ? '‚ù§Ô∏è‚Äçü©π' : '‚ö†Ô∏è';
                result += `${statusIcon} <strong>Tr·∫°ng th√°i:</strong> ${status}<br>`;
            }
            return result;
        }

        function formatJsonValue(value, indent = 0) {
            const indentStr = '&nbsp;'.repeat(indent * 4);

            if (typeof value === 'object' && value !== null) {
                let result = '';
                for (const [k, v] of Object.entries(value)) {
                    result += `${indentStr}‚Ä¢ <strong>${k}:</strong> `;
                    if (typeof v === 'object') {
                        result += '<br>' + formatJsonValue(v, indent + 1);
                    } else {
                        result += `${v}<br>`;
                    }
                }
                return result;
            }

            return `${indentStr}${value}<br>`;
        }
    </script>
</body>
</html>
